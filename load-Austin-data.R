require(gdata)
library(ks)
library(RColorBrewer)
require(rgdal)
library(MASS)
require(dplyr)

source("CrimeUtil.R")

#setwd("~/Documents/DSI/notes/2-SYS-6018/Case Study 1 - crime/SYS-6018-cs1")

# LOAD THE DATA
# boundary <-readOGR(dsn="Neighborhood-Planning-Areas",layer="geo_export_bf249074-a2fc-4d35-b70e-d75de1175a06")
# plot(boundary)

boundary <-readOGR(dsn=".", layer="geo_export_7c52f690-58f6-4f4a-96fa-95df45d3770a")

# This will draw the entire map of Austin. Available for export from: 
# https://data.austintexas.gov/Government/Austin-Police-Sectors-and-Districts/bh6h-vpxb
#boundary <-readOGR(dsn="Austin Police Sectors and Districts", layer="geo_export_7c52f690-58f6-4f4a-96fa-95df45d3770a")

plot(boundary)

stores <- read.csv("stores_info.csv", stringsAsFactors = F)
store_coords <- data.frame(x=stores$Long, y=stores$Lat)
coordinates(store_coords) <- c('x','y')
plot(store_coords, col="blue", add=T)

crimes <- read.csv("Annual_Crime_Dataset_2015.csv", stringsAsFactors = F)
crimes <- filter(crimes, GO.X.Coordinate != "") # remove crimes that have no location data

coords <- data.frame(x=crimes$GO.X.Coordinate, y=crimes$GO.Y.Coordinate)
coordinates(coords) <- c('x','y')
proj4string(coords) <- CRS("+init=epsg:2277")
coords_r <- spTransform(coords,CRS("+init=epsg:4326"))

crimes$long <- coordinates(coords_r)[,1]
crimes$lat <- coordinates(coords_r)[,2]

# Reproject crime lon/lat points to meters
crime.locations.lonlat = cbind(crimes$long, crimes$lat)
crime.locations.meters = project(crime.locations.lonlat, proj="+init=epsg:26971")

# Reproject store location points to meters
store.locations.lonlat = cbind(stores$Long, stores$Lat)
store.locations.meters = project(store.locations.lonlat, proj="+init=epsg:26971")

# Create data frame from crime.locations.meters
crime.locations <- as.data.frame(crime.locations.meters)
names(crime.locations) <- c("x","y")

kde.sample.points = crime.locations[,c("x","y")]

austin = spTransform(boundary, CRS(proj="+init=epsg:26971"))

# get estimation points for KDE
kde.resolution.meters = 200
kde.est.points = get.grid.points(austin, kde.resolution.meters, FALSE)

# run and plot KDE, using 500 points from the sample
kde.est = run.spatial.kde(kde.sample.points, kde.est.points, 500) 
plot.spatial.kde(kde.est, kde.est.points)
plot(austin, add=T)

store_meters <- data.frame(x=store.locations.meters[,1], y=store.locations.meters[,2])
coordinates(store_meters) <- c('x','y')
plot(store_meters, col="red", add=T)

####

getCrimes <- function(add, crimes) {
  # if there's a comma in the address, strip off what's before the comma (shopping mall name, etc.)
  if (grepl(",", add)) {
    add <- gsub("^.+, ", "", add)
  }
  # split on blank space
  addS <- unlist(strsplit(add, " "))
  # find the addresses that match
  winners <- sapply(crimes$GO.Location, addyPart, addS = addS, USE.NAMES = F)
  # subset to only those addresses
  addDF <- crimes[winners, ]
  # print the count
  print(paste(add, nrow(addDF))) 
  # return the subset
  addDF
}

addyPart <- function(addToCheck, addS) {
  # set the threshold for what percentage of the address has to match
  thresh <- .6 * length(addS)
  # initiate the count of matching words
  count <- 0
  # make both lower case
  addS <- tolower(addS)
  addToCheck <- tolower(addToCheck)
  # store the house number (or if there isn't one, store FALSE)
  if (grepl('[0-9]', addS[1])) {
    num <- addS[1]
  } else {
    num <- FALSE
  }
  # for each word in the address, store the count of how many are in the address we're checking
  for (i in 1:length(addS)){
    if (grepl(paste('\\b',addS[i],'\\b',sep=''), addToCheck)) {
      count <- count + 1
    }
  }
  if (count >= thresh) {
    # if we pass the threshold AND it matches the house number, return TRUE
    if (num != FALSE & grepl(paste('\\b',num,'\\b',sep=''), addToCheck)) {
      TRUE
    } else {
      FALSE
    }
  } else {
    FALSE
  }
}

### FAKE UNIT TEST
#addyPart("Ben White 710", c("710", "E", "Ben", "White", "Blvd")) # should be TRUE
#addyPart("Ben White", c("710", "E", "Ben", "White", "Blvd")) # should be FALSE
#bw <- getCrimes("710 E Ben White Blvd", crimes)

# make a list with a data frame for each store and all its crimes
scdf <- lapply(stores$address, getCrimes, crimes = crimes)

#make a data frame with counts for each address
storeCrimeCount <- data.frame(store = character(nrow(stores)),
                              address = character(nrow(stores)),
                              crimes = numeric(nrow(stores)), stringsAsFactors = F)
for (j in 1:nrow(stores)) {
  storeCrimeCount[j, ] <- c(stores$store[j], stores$address[j], nrow(scdf[[j]]))
}

# look at the addresses with zero crimes
zeros <- storeCrimeCount[storeCrimeCount$crimes==0, ]
# what percentage of our data set is zero?
nrow(zeros) / nrow(stores)

stores <- cbind(stores)